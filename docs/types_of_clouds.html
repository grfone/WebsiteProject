<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GRF - Type of Clouds</title>
    <link rel="icon" type="image/x-icon" href="images/favicon_16_to_1024.ico">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
    <!-- Header (matches main page) -->
    <header class="relative bg-cover bg-center h-64 flex items-center justify-center" style="background-image: url('images/banner.jpg')">
        <h1 class="text-6xl font-bold text-white drop-shadow-lg">GRF</h1>
    </header>

    <!-- Navigation (matches main page) -->
    <nav class="bg-blue-600 text-white p-4">
        <ul class="flex justify-center space-x-8">
            <li><a href="index.html" class="hover:underline">Home</a></li>
            <li><a href="types_of_clouds.html" class="hover:underline">Types of Clouds</a></li>
        </ul>
    </nav>

<!-- Main content -->
<main class="max-w-4xl mx-auto my-8 p-4 text-center">
  <h2 class="text-3xl font-semibold mb-4">Upload a Cloud Image</h2>
  <p class="text-lg mb-6">
    Upload an image of a cloud by clicking the button below or dragging and
    dropping it into the area. We'll predict its type using AI!
  </p>

  <!-- File upload button -->
  <div class="mb-6">
    <label
      for="imageUpload"
      class="inline-block bg-blue-600 text-white px-4 py-2 rounded cursor-pointer hover:bg-blue-700"
    >
      Choose Image
    </label>
    <input type="file" id="imageUpload" accept="image/*" class="hidden" />
  </div>

  <!-- Drag-and-drop area -->
  <div
    id="dropArea"
    class="border-2 border-dashed border-gray-400 rounded-lg p-6 mx-auto max-w-md h-48 flex items-center justify-center text-gray-500 hover:border-blue-600 transition-colors"
  >
    <p>Drag and drop your image here</p>
  </div>

  <!-- Result display -->
  <div id="result" class="mt-6 hidden">
    <h3 class="text-xl font-semibold mb-2">Prediction Result</h3>
    <p class="text-lg">
      Predicted Cloud Type: <span id="cloudType" class="font-bold"></span>
    </p>
    <img
      id="previewImage"
      alt="Uploaded Cloud Image"
      class="mx-auto mt-4 rounded-lg shadow-lg max-w-full h-auto"
      style="max-width: 300px"
    />
  </div>
</main>

<!-- ONNX Runtime -->
<script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>


<!-- JavaScript for drag-and-drop and file input handling -->
<script>
  const dropArea = document.getElementById("dropArea");
  const imageUpload = document.getElementById("imageUpload");
  const previewImage = document.getElementById("previewImage");
  const result = document.getElementById("result");
  const cloudType = document.getElementById("cloudType");

  let session;

  const classLabels = [
    "Altocumulus", "Altostratus", "Cirrocumulus", "Cirrostratus",
    "Cirrus", "Contrail", "Cumulonimbus", "Cumulus",
    "Nimbostratus", "Stratocumulus", "Stratus"
  ];

   const cloudDescriptions = {
        "Altocumulus": "Altocumulus clouds are mid-level clouds appearing as white or gray patches, often arranged in a regular pattern or ripples. They form on clear, sunny days and are typically found between 6,500 and 20,000 feet. These clouds are composed of water droplets and sometimes ice crystals. Interestingly, they can sometimes create a 'mackerel sky' pattern, resembling the scales of a mackerel fish.",
        "Altostratus": "Altostratus clouds are mid-level, gray or blue-gray sheets that often cover the entire sky, creating a uniform layer. Found between 6,500 and 20,000 feet, they are usually composed of water droplets and ice crystals, often indicating an approaching warm front or storm. Fun fact: these clouds can produce a faint halo around the sun or moon due to their thin, translucent nature.",
        "Cirrocumulus": "Cirrocumulus are high-altitude clouds forming small, white, rippled patches, often arranged in rows or a grid-like pattern. Found above 16,500 feet, they are made of ice crystals and indicate fair but cold weather. A quirky trait: they sometimes resemble tiny cotton balls scattered across the sky, giving a whimsical, delicate appearance.",
        "Cirrostratus": "Cirrostratus are thin, high veil-like clouds covering the sky above 16,500 feet, composed entirely of ice crystals. They often create a halo effect around the sun or moon and signal an approaching weather change, typically within 24 hours. Interestingly, their delicate veil can sometimes make the sky look like itâ€™s covered in a gossamer sheet.",
        "Cirrus": "Cirrus clouds are high, wispy, feathery streaks above 16,500 feet, made of ice crystals due to the cold temperatures at that altitude. They often indicate fair weather but can signal an approaching storm. A fascinating tidbit: their delicate, feather-like appearance inspired their name, derived from the Latin word for 'curl' or 'fringe.'",
        "Contrail": "Contrails are linear clouds formed by aircraft exhaust condensing into ice crystals at high altitudes, typically above 26,000 feet. They appear as white streaks trailing behind planes and can persist or dissipate based on atmospheric conditions. Fun fact: contrails can sometimes spread out to form cirrus-like clouds, influencing local weather patterns.",
        "Cumulonimbus": "Cumulonimbus are towering, dense clouds with anvil-shaped tops, extending from low to high altitudes, often exceeding 20,000 feet. They are associated with thunderstorms, heavy rain, lightning, and even tornadoes. Interestingly, their anvil shape forms when strong winds at high altitudes flatten the cloud top, creating a dramatic, ominous silhouette.",
        "Cumulus": "Cumulus are low-level, puffy, cotton-like white clouds below 6,500 feet, often seen on clear, sunny days. Composed of water droplets, they indicate fair weather but can grow into storm clouds. A charming fact: their fluffy, sculpted appearance has inspired artists and poets to liken them to cotton candy floating in the sky.",
        "Nimbostratus": "Nimbostratus are thick, dark gray clouds covering the sky from low to mid levels, typically below 10,000 feet. They bring continuous rain or snow and are composed of water droplets and ice crystals. A curious note: these clouds can make the day feel perpetually gloomy, as they block out sunlight for hours.",
        "Stratocumulus": "Stratocumulus are low, lumpy, layered clouds below 6,500 feet, often covering the sky in patches with breaks of clear sky in between. They are usually composed of water droplets and indicate unsettled weather. Fun fact: their bumpy texture can resemble a quilted blanket spread across the sky.",
        "Stratus": "Stratus are uniform, low-level gray clouds resembling fog lifted off the ground, typically below 6,500 feet. They often bring drizzle or light snow and are made of water droplets. Interestingly, stratus clouds can create a moody, overcast atmosphere, often featured in films to set a somber or mysterious tone."
   };

  async function loadModel() {
    session = await ort.InferenceSession.create("model.onnx");
  }
  loadModel();

  // File input handler
  imageUpload.addEventListener("change", (event) => {
    const file = event.target.files[0];
    if (file) displayImage(file);
  });

  // Drag & drop
  dropArea.addEventListener("dragover", (event) => {
    event.preventDefault();
    dropArea.classList.add("border-blue-600");
  });
  dropArea.addEventListener("dragleave", () => dropArea.classList.remove("border-blue-600"));
  dropArea.addEventListener("drop", (event) => {
    event.preventDefault();
    dropArea.classList.remove("border-blue-600");
    const file = event.dataTransfer.files[0];
    if (file && file.type.startsWith("image/")) displayImage(file);
    else alert("Please drop a valid image file.");
  });

  function displayImage(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = async () => {
        const size = Math.min(img.width, img.height);
        const sx = (img.width - size) / 2;
        const sy = (img.height - size) / 2;

        const canvas = document.createElement("canvas");
        canvas.width = canvas.height = 380;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, sx, sy, size, size, 0, 0, 380, 380);

        previewImage.src = canvas.toDataURL();
        result.classList.remove("hidden");
        cloudType.textContent = "Processing...";

        // Run model
        const inputTensor = preprocessCanvas(canvas);
        const output = await session.run({ input: inputTensor });
        const outputData = output[Object.keys(output)[0]].data;
        const classIdx = argMax(outputData);
        const className = classLabels[classIdx];
        const description = cloudDescriptions[className] || "No description available.";

        cloudType.innerHTML = `${className} <br><br> <span style="font-weight: normal;">${description}</span>
          <br><br> <small style="font-weight: normal;"><i>The program always assumes that the user knows what a cloud is. Non-cloud images will get a random classification.</i></small>`;
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }

  function preprocessCanvas(canvas) {
    const ctx = canvas.getContext("2d");
    const imgData = ctx.getImageData(0, 0, 380, 380).data;
    const floatData = new Float32Array(380 * 380 * 3);
    for (let i = 0, j = 0; i < imgData.length; i += 4, j += 3) {
      floatData[j] = imgData[i];
      floatData[j + 1] = imgData[i + 1];
      floatData[j + 2] = imgData[i + 2];
    }
    return new ort.Tensor("float32", floatData, [1, 380, 380, 3]);
  }

  function argMax(array) {
    let maxIdx = 0, maxVal = array[0];
    for (let i = 1; i < array.length; i++) {
      if (array[i] > maxVal) {
        maxVal = array[i];
        maxIdx = i;
      }
    }
    return maxIdx;
  }

    async function sendToServer(file) {
      try {
        const formData = new FormData();
        formData.append("file", file);

        // Step 1: Get signed URL from your backend
        const res = await fetch("https://websiteproject-zf7r.onrender.com/get-upload-url", {
          method: "POST",
          body: formData
        });
        if (!res.ok) throw new Error("Failed to get signed URL");

        const data = await res.json(); // { signed_url, filename }

        // Step 2: Upload the file using PUT to Supabase storage
        const uploadRes = await fetch(data.signed_url, {
          method: "PUT",
          body: file,
          headers: {
            "Content-Type": file.type
          }
        });

        if (!uploadRes.ok) throw new Error("Upload to storage failed");

        cloudType.innerHTML += `<br><br><small style="color:green;">Image saved on server as: ${data.filename}</small>`;
      } catch (err) {
        console.warn("Upload failed:", err);
        cloudType.innerHTML += `<br><br><small style="color:red;">âš  Could not save image to server.</small>`;
      }
    }
</script>
