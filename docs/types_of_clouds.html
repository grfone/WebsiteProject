<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GRF - Type of Clouds</title>
    <link rel="icon" type="image/x-icon" href="images/favicon_16_to_1024.ico">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
    <!-- Header (matches main page) -->
    <header class="relative bg-cover bg-center h-64 flex items-center justify-center" style="background-image: url('images/banner.jpg')">
        <h1 class="text-6xl font-bold text-white drop-shadow-lg">GRF</h1>
    </header>

    <!-- Navigation (matches main page) -->
    <nav class="bg-blue-600 text-white p-4">
        <ul class="flex justify-center space-x-8">
            <li><a href="index.html" class="hover:underline">Home</a></li>
            <li><a href="types_of_clouds.html" class="hover:underline">Types of Clouds</a></li>
        </ul>
    </nav>

<!-- Main content -->
<main class="max-w-4xl mx-auto my-8 p-4 text-center">
  <h2 class="text-3xl font-semibold mb-4">Upload a Cloud Image</h2>
  <p class="text-lg mb-6">
    Upload an image of a cloud by clicking the button below or dragging and
    dropping it into the area. We'll predict its type using AI!
  </p>

  <!-- File upload button -->
  <div class="mb-6">
    <label
      for="imageUpload"
      class="inline-block bg-blue-600 text-white px-4 py-2 rounded cursor-pointer hover:bg-blue-700"
    >
      Choose Image
    </label>
    <input type="file" id="imageUpload" accept="image/*" class="hidden" />
  </div>

  <!-- Drag-and-drop area -->
  <div
    id="dropArea"
    class="border-2 border-dashed border-gray-400 rounded-lg p-6 mx-auto max-w-md h-48 flex items-center justify-center text-gray-500 hover:border-blue-600 transition-colors"
  >
    <p>Drag and drop your image here</p>
  </div>

  <!-- Result display -->
  <div id="result" class="mt-6 hidden">
    <h3 class="text-xl font-semibold mb-2">Prediction Result</h3>
    <p class="text-lg">
      Predicted Cloud Type: <span id="cloudType" class="font-bold"></span>
    </p>
    <img
      id="previewImage"
      alt="Uploaded Cloud Image"
      class="mx-auto mt-4 rounded-lg shadow-lg max-w-full h-auto"
      style="max-width: 300px"
    />
  </div>
</main>

<!-- ONNX Runtime -->
<script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>


<!-- JavaScript for drag-and-drop and file input handling -->
<script>
  const dropArea = document.getElementById("dropArea");
  const imageUpload = document.getElementById("imageUpload");
  const previewImage = document.getElementById("previewImage");
  const result = document.getElementById("result");
  const cloudType = document.getElementById("cloudType");

  let session;

  const classLabels = [
    "Altocumulus", "Altostratus", "Cirrocumulus", "Cirrostratus",
    "Cirrus", "Contrail", "Cumulonimbus", "Cumulus",
    "Nimbostratus", "Stratocumulus", "Stratus"
  ];

   const cloudDescriptions = {
    "Altocumulus": "Altocumulus clouds are mid-level clouds, typically found between 6,500 and 20,000 feet, appearing as white or gray patches with a wavy or rippled texture. They form on clear, sunny days when warm, moist air rises and cools, causing water vapor to condense into droplets or ice crystals. These clouds often arrange in rows or a grid-like pattern, resembling small, fluffy waves. They can signal a change in weather, especially when followed by altostratus clouds. Fascinatingly, their 'mackerel sky' pattern, resembling fish scales, has been used by sailors for centuries as a natural weather predictor, often signaling rain within 36 hours.",
    "Altostratus": "Altostratus clouds are mid-level clouds, found between 6,500 and 20,000 feet, forming expansive, gray or blue-gray sheets that often blanket the entire sky. Composed of water droplets and ice crystals, they result from large-scale lifting of moist air, such as ahead of a warm front or low-pressure system. They often appear thin enough to dimly reveal the sun, like viewing it through frosted glass. These clouds typically precede rain or snow. A captivating fact: their halo effect around the sun or moon, caused by light refracting through ice crystals, has inspired myths about celestial omens in ancient cultures.",
    "Cirrocumulus": "Cirrocumulus clouds are high-altitude clouds, forming above 16,500 feet, appearing as small, white, rippled patches arranged in rows or a grid. Made entirely of ice crystals due to the frigid temperatures at high altitudes, they form when turbulent air causes small cloudlets to develop. They often indicate fair but cold weather, though their presence can hint at an approaching warm front. A delightful quirk: their tiny, granular appearance can make the sky look like it’s dusted with sugar, and they’re sometimes called 'cloudlets' for their petite, charming structure.",
    "Cirrostratus": "Cirrostratus clouds are high-altitude, veil-like clouds above 16,500 feet, forming thin, translucent sheets that can cover the entire sky. Composed of ice crystals, they result from the gradual lifting of a large air mass, often ahead of a storm system. They’re known for creating a halo effect around the sun or moon due to light refraction. These clouds often signal rain or snow within 12 to 24 hours. Intriguingly, their ethereal, gossamer-like appearance has been likened to a celestial veil, inspiring poets to describe them as the 'sky’s wedding lace.'",
    "Cirrus": "Cirrus clouds are high-altitude clouds, found above 16,500 feet, appearing as delicate, wispy, feathery streaks across the sky. Formed entirely of ice crystals due to the extreme cold at these heights, they develop when moist air rises and freezes in strong upper-level winds. They typically indicate fair weather but can precede a storm if they thicken. A mesmerizing fact: their name, from the Latin 'cirrus' meaning 'curl,' reflects their delicate, hair-like structure, and they’ve been used in folklore to predict weather changes, often called 'mare’s tails' for their flowing appearance.",
    "Contrail": "Contrails, or condensation trails, are linear clouds formed by aircraft exhaust at high altitudes, typically above 26,000 feet, where water vapor condenses and freezes into ice crystals. They form in cold, humid air and can persist for hours or dissipate quickly, depending on atmospheric conditions. Contrails can spread into cirrus-like clouds, affecting local climate. A curious tidbit: during World War II, pilots used contrails to spot enemy aircraft, but their visibility also made stealth missions trickier, leading to tactical flight adjustments.",
    "Cumulonimbus": "Cumulonimbus clouds are massive, towering clouds that can extend from low altitudes to over 20,000 feet, often with a distinctive anvil-shaped top. Formed on hot, humid days when warm air rises rapidly, they carry water droplets, ice crystals, and powerful updrafts, leading to thunderstorms, heavy rain, lightning, hail, or even tornadoes. Their anvil shape forms when strong high-altitude winds shear the cloud top. A striking fact: these clouds can reach heights rivaling Mount Everest, making them the giants of the sky, capable of producing lightning that strikes over 10 miles away.",
    "Cumulus": "Cumulus clouds are low-level clouds, typically below 6,500 feet, appearing as puffy, white, cotton-like formations with sharp edges. They form on clear, sunny days when warm air rises, cools, and condenses into water droplets. These clouds often indicate fair weather but can grow into cumulonimbus if conditions become unstable. A whimsical note: their fluffy, sculpted shapes have inspired countless daydreamers to see animals, faces, or fantastical figures in the sky, making them a universal symbol of imagination.",
    "Nimbostratus": "Nimbostratus clouds are thick, dark gray clouds spanning low to mid altitudes, typically below 10,000 feet, forming a heavy, uniform layer that obscures the sky. Composed of water droplets and ice crystals, they develop from large, moist air masses associated with frontal systems, bringing steady rain or snow for hours. A peculiar fact: their relentless, gloomy coverage can last so long that they’ve been nicknamed 'rain blankets,' and their presence often prompts cozy indoor activities like reading or movie marathons.",
    "Stratocumulus": "Stratocumulus clouds are low-level clouds, below 6,500 feet, appearing as lumpy, layered patches with breaks of clear sky in between. Formed from spreading air masses or the breakup of stratus clouds, they consist of water droplets and indicate unsettled weather, sometimes bringing light rain. A charming detail: their quilted, bumpy texture can resemble a patchwork sky, and they often create stunning sunsets when their edges catch the golden hues of dawn or dusk.",
    "Stratus": "Stratus clouds are low-level, uniform gray clouds, typically below 6,500 feet, resembling a thick layer of fog lifted just off the ground. Composed of water droplets, they form in stable, moist air and often bring drizzle or light snow. They create a dull, overcast sky. An evocative fact: their heavy, oppressive appearance has made them a favorite in literature and film to set a melancholic or mysterious mood, often symbolizing a world shrouded in secrets."
};

  async function loadModel() {
    session = await ort.InferenceSession.create("model.onnx");
  }
  loadModel();

  // File input handler
  imageUpload.addEventListener("change", (event) => {
    const file = event.target.files[0];
    if (file) displayImage(file);
  });

  // Drag & drop
  dropArea.addEventListener("dragover", (event) => {
    event.preventDefault();
    dropArea.classList.add("border-blue-600");
  });
  dropArea.addEventListener("dragleave", () => dropArea.classList.remove("border-blue-600"));
  dropArea.addEventListener("drop", (event) => {
    event.preventDefault();
    dropArea.classList.remove("border-blue-600");
    const file = event.dataTransfer.files[0];
    if (file && file.type.startsWith("image/")) displayImage(file);
    else alert("Please drop a valid image file.");
  });

  function displayImage(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = async () => {
        const size = Math.min(img.width, img.height);
        const sx = (img.width - size) / 2;
        const sy = (img.height - size) / 2;

        const canvas = document.createElement("canvas");
        canvas.width = canvas.height = 380;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, sx, sy, size, size, 0, 0, 380, 380);

        previewImage.src = canvas.toDataURL();
        result.classList.remove("hidden");
        cloudType.textContent = "Processing...";

        // Run model
        const inputTensor = preprocessCanvas(canvas);
        const output = await session.run({ input: inputTensor });
        const outputData = output[Object.keys(output)[0]].data;
        const classIdx = argMax(outputData);
        const className = classLabels[classIdx];
        const description = cloudDescriptions[className] || "No description available.";

        cloudType.innerHTML = `${className} <br><br> <span style="font-weight: normal;">${description}</span>
          <br><br> <small style="font-weight: normal;"><i>The program always assumes that the user knows what a cloud is. Non-cloud images will get a random classification.</i></small>`;
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }

  function preprocessCanvas(canvas) {
    const ctx = canvas.getContext("2d");
    const imgData = ctx.getImageData(0, 0, 380, 380).data;
    const floatData = new Float32Array(380 * 380 * 3);
    for (let i = 0, j = 0; i < imgData.length; i += 4, j += 3) {
      floatData[j] = imgData[i];
      floatData[j + 1] = imgData[i + 1];
      floatData[j + 2] = imgData[i + 2];
    }
    return new ort.Tensor("float32", floatData, [1, 380, 380, 3]);
  }

  function argMax(array) {
    let maxIdx = 0, maxVal = array[0];
    for (let i = 1; i < array.length; i++) {
      if (array[i] > maxVal) {
        maxVal = array[i];
        maxIdx = i;
      }
    }
    return maxIdx;
  }

    async function sendToServer(file) {
      try {
        const formData = new FormData();
        formData.append("file", file);

        // Step 1: Get signed URL from your backend
        const res = await fetch("https://websiteproject-zf7r.onrender.com/get-upload-url", {
          method: "POST",
          body: formData
        });
        if (!res.ok) throw new Error("Failed to get signed URL");

        const data = await res.json(); // { signed_url, filename }

        // Step 2: Upload the file using PUT to Supabase storage
        const uploadRes = await fetch(data.signed_url, {
          method: "PUT",
          body: file,
          headers: {
            "Content-Type": file.type
          }
        });

        if (!uploadRes.ok) throw new Error("Upload to storage failed");

        cloudType.innerHTML += `<br><br><small style="color:green;">Image saved on server as: ${data.filename}</small>`;
      } catch (err) {
        console.warn("Upload failed:", err);
        cloudType.innerHTML += `<br><br><small style="color:red;">⚠ Could not save image to server.</small>`;
      }
    }
</script>
